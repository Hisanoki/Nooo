local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer

-- --- C·∫§U H√åNH ---
local CONFIG = {
    Range = 40,
    AllyName = "GrahamScyther",
    BubbleColor = Color3.fromRGB(0, 170, 255),
    BubbleTransparency = 0.6,
    SkillPrefix = "Kamen Rider",
    SkillSuffix = "Chalice",
    TeleportDelay = 0.3,
    TeleportCooldown = 5,
    SkillDelay = 0.2,
    SelectedSkills = {
        R = true,
        T = false,
        F = false,
        G = false
    },
    AntiStunDuration = 0.2,
    AntiStunCooldown = 2, -- H·ªìi chi√™u Anti-Stun
    AntiStunEnabled = false
}

-- --- BI·∫æN TR·∫†NG TH√ÅI ---
local isAiming = false
local isAntiRunner = false
local currentTarget = nil
local lastTeleportTime = 0
local teleportCooldownRemaining = 0
local lastAntiStunTime = 0
local antiStunCooldownRemaining = 0
local isAntiStunActive = false

-- Cache c√°c ƒë·ªëi t∆∞·ª£ng th∆∞·ªùng d√πng ƒë·ªÉ gi·∫£m tra c·ª©u
local cachedCharacter = nil
local cachedRootPart = nil
local cachedHumanoid = nil

-- --- H√ÄM ANTI-STUN T·ªêI ∆ØU ---
local function ApplyAntiStun()
    if not cachedCharacter or not cachedRootPart or not cachedHumanoid then return end
    
    -- Gi·∫£i ph√≥ng c√°c tr·∫°ng th√°i b·ªã kh·ªëng ch·∫ø
    cachedRootPart.Anchored = false
    cachedHumanoid.PlatformStand = false
    cachedHumanoid.Sit = false
    
    -- D·ªçn d·∫πp c√°c l·ª±c ƒë·∫©y (t·ªëi ∆∞u b·∫±ng c√°ch cache)
    for _, obj in pairs(cachedRootPart:GetChildren()) do
        if obj:IsA("BodyMover") then
            obj:Destroy()
        end
    end
end

-- --- H√ÄM K√çCH HO·∫†T ANTI-STUN V·ªöI COOLDOWN ---
local function TriggerAntiStun()
    local currentTime = tick()
    
    -- Ki·ªÉm tra cooldown
    if currentTime - lastAntiStunTime < CONFIG.AntiStunCooldown then
        return false
    end
    
    isAntiStunActive = true
    lastAntiStunTime = currentTime
    antiStunCooldownRemaining = CONFIG.AntiStunCooldown
    
    -- √Åp d·ª•ng Anti-Stun trong kho·∫£ng th·ªùi gian c·ªë ƒë·ªãnh
    task.spawn(function()
        local startTime = tick()
        while tick() - startTime < CONFIG.AntiStunDuration do
            ApplyAntiStun()
            task.wait()
        end
        isAntiStunActive = false
    end)
    
    return true
end

-- --- T·∫†O GUI HI·ªÜN ƒê·∫†I (COMPACT) ---
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ModernAimGUI_MobileV2"
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
ScreenGui.ResetOnSpawn = false

-- === N√öT TP DI ƒê·ªòNG ===
local MobileTPBtn = Instance.new("TextButton")
MobileTPBtn.Name = "MobileTPButton"
MobileTPBtn.Parent = ScreenGui
MobileTPBtn.BackgroundColor3 = Color3.fromRGB(255, 80, 80)
MobileTPBtn.Position = UDim2.new(0.85, 0, 0.6, 0)
MobileTPBtn.Size = UDim2.new(0, 30, 0, 30)
MobileTPBtn.Font = Enum.Font.GothamBold
MobileTPBtn.Text = "‚ö°"
MobileTPBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
MobileTPBtn.TextSize = 30
MobileTPBtn.AutoButtonColor = true
MobileTPBtn.Active = true
MobileTPBtn.Draggable = true

local TPBtnCorner = Instance.new("UICorner")
TPBtnCorner.CornerRadius = UDim.new(1, 0)
TPBtnCorner.Parent = MobileTPBtn

local TPBtnStroke = Instance.new("UIStroke")
TPBtnStroke.Color = Color3.fromRGB(255, 255, 255)
TPBtnStroke.Thickness = 2
TPBtnStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
TPBtnStroke.Parent = MobileTPBtn

local TPShadow = Instance.new("ImageLabel")
TPShadow.Name = "Shadow"
TPShadow.Parent = MobileTPBtn
TPShadow.AnchorPoint = Vector2.new(0.5, 0.5)
TPShadow.Position = UDim2.new(0.5, 0, 0.5, 0)
TPShadow.Size = UDim2.new(1.2, 0, 1.2, 0)
TPShadow.BackgroundTransparency = 1
TPShadow.Image = "rbxassetid://1316045217"
TPShadow.ImageColor3 = Color3.fromRGB(0, 0, 0)
TPShadow.ImageTransparency = 0.6
TPShadow.ZIndex = -1

-- Main Frame
local MainFrame = Instance.new("ImageLabel")
MainFrame.Name = "MainFrame"
MainFrame.Parent = ScreenGui
MainFrame.Image = "rbxassetid://122727189017649"
MainFrame.ScaleType = Enum.ScaleType.Stretch
MainFrame.BackgroundTransparency = 1
MainFrame.Position = UDim2.new(0.5, -140, 0.1, 0)
MainFrame.Size = UDim2.new(0, 280, 0, 520)
MainFrame.Active = true
MainFrame.Draggable = true

local MainStroke = Instance.new("UIStroke")
MainStroke.Color = Color3.fromRGB(0, 120, 215)
MainStroke.Thickness = 2
MainStroke.Parent = MainFrame

-- Header
local Header = Instance.new("TextLabel")
Header.Parent = MainFrame
Header.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
Header.Size = UDim2.new(1, 0, 0, 40)
Header.Font = Enum.Font.GothamBold
Header.Text = "üéØ AIM PRO V2"
Header.TextColor3 = Color3.fromRGB(255, 255, 255)
Header.TextSize = 16

local HeaderCorner = Instance.new("UICorner")
HeaderCorner.CornerRadius = UDim.new(0, 10)
HeaderCorner.Parent = Header

-- N√∫t ƒë√≥ng/m·ªü GUI
local ToggleBtn = Instance.new("ImageButton")
ToggleBtn.Parent = ScreenGui
ToggleBtn.Image = "rbxassetid://122727189017649"
ToggleBtn.ScaleType = Enum.ScaleType.Stretch
ToggleBtn.BackgroundTransparency = 1
ToggleBtn.Position = UDim2.new(0.02, 0, 0.5, 0)
ToggleBtn.Size = UDim2.new(0, 45, 0, 45)
ToggleBtn.Active = true
ToggleBtn.Draggable = true

local ToggleBtnStroke = Instance.new("UIStroke")
ToggleBtnStroke.Color = Color3.fromRGB(0, 120, 215)
ToggleBtnStroke.Thickness = 2
ToggleBtnStroke.Parent = ToggleBtn

local ToggleCorner = Instance.new("UICorner")
ToggleCorner.CornerRadius = UDim.new(0, 22)
ToggleCorner.Parent = ToggleBtn

local ToggleBtnText = Instance.new("TextLabel")
ToggleBtnText.Parent = ToggleBtn
ToggleBtnText.BackgroundTransparency = 1
ToggleBtnText.Size = UDim2.new(1, 0, 1, 0)
ToggleBtnText.Font = Enum.Font.GothamBold
ToggleBtnText.Text = "‚ò∞"
ToggleBtnText.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleBtnText.TextSize = 22

local guiVisible = true
ToggleBtn.MouseButton1Click:Connect(function()
    guiVisible = not guiVisible
    MainFrame.Visible = guiVisible
    ToggleBtnText.Text = guiVisible and "‚ò∞" or "+"
end)

-- TP Cooldown Timer Display
local CooldownFrame = Instance.new("Frame")
CooldownFrame.Parent = ScreenGui
CooldownFrame.BackgroundColor3 = Color3.fromRGB(0, 90, 160)
CooldownFrame.Position = UDim2.new(0.02, 0, 0.1, 0)
CooldownFrame.Size = UDim2.new(0, 90, 0, 55)
CooldownFrame.Visible = false

local CooldownCorner = Instance.new("UICorner")
CooldownCorner.CornerRadius = UDim.new(0, 10)
CooldownCorner.Parent = CooldownFrame

local CooldownLabel = Instance.new("TextLabel")
CooldownLabel.Parent = CooldownFrame
CooldownLabel.BackgroundTransparency = 1
CooldownLabel.Size = UDim2.new(1, 0, 0.5, 0)
CooldownLabel.Font = Enum.Font.GothamBold
CooldownLabel.Text = "TP CD"
CooldownLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
CooldownLabel.TextSize = 13

local CooldownTimer = Instance.new("TextLabel")
CooldownTimer.Parent = CooldownFrame
CooldownTimer.BackgroundTransparency = 1
CooldownTimer.Position = UDim2.new(0, 0, 0.5, 0)
CooldownTimer.Size = UDim2.new(1, 0, 0.5, 0)
CooldownTimer.Font = Enum.Font.GothamBold
CooldownTimer.Text = "0.0s"
CooldownTimer.TextColor3 = Color3.fromRGB(255, 255, 255)
CooldownTimer.TextSize = 18

-- === ANTI-STUN COOLDOWN DISPLAY (M·ªöI) ===
local AntiStunFrame = Instance.new("Frame")
AntiStunFrame.Parent = ScreenGui
AntiStunFrame.BackgroundColor3 = Color3.fromRGB(160, 90, 0)
AntiStunFrame.Position = UDim2.new(0.02, 0, 0.18, 0) -- D∆∞·ªõi TP CD
AntiStunFrame.Size = UDim2.new(0, 90, 0, 55)
AntiStunFrame.Visible = false

local AntiStunCorner = Instance.new("UICorner")
AntiStunCorner.CornerRadius = UDim.new(0, 10)
AntiStunCorner.Parent = AntiStunFrame

local AntiStunLabel = Instance.new("TextLabel")
AntiStunLabel.Parent = AntiStunFrame
AntiStunLabel.BackgroundTransparency = 1
AntiStunLabel.Size = UDim2.new(1, 0, 0.5, 0)
AntiStunLabel.Font = Enum.Font.GothamBold
AntiStunLabel.Text = "Anti-Stun"
AntiStunLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
AntiStunLabel.TextSize = 12

local AntiStunTimer = Instance.new("TextLabel")
AntiStunTimer.Parent = AntiStunFrame
AntiStunTimer.BackgroundTransparency = 1
AntiStunTimer.Position = UDim2.new(0, 0, 0.5, 0)
AntiStunTimer.Size = UDim2.new(1, 0, 0.5, 0)
AntiStunTimer.Font = Enum.Font.GothamBold
AntiStunTimer.Text = "0.0s"
AntiStunTimer.TextColor3 = Color3.fromRGB(255, 255, 255)
AntiStunTimer.TextSize = 18

-- ScrollingFrame
local ScrollFrame = Instance.new("ScrollingFrame")
ScrollFrame.Parent = MainFrame
ScrollFrame.BackgroundTransparency = 1
ScrollFrame.Position = UDim2.new(0, 0, 0, 45)
ScrollFrame.Size = UDim2.new(1, 0, 1, -45)
ScrollFrame.CanvasSize = UDim2.new(0, 0, 0, 800)
ScrollFrame.ScrollBarThickness = 4
ScrollFrame.ScrollBarImageColor3 = Color3.fromRGB(0, 120, 215)

-- Functions t·∫°o GUI components
local function CreateToggle(name, text, position)
    local frame = Instance.new("Frame")
    frame.Parent = ScrollFrame
    frame.BackgroundColor3 = Color3.fromRGB(0, 80, 140)
    frame.Position = position
    frame.Size = UDim2.new(0.9, 0, 0, 42)
    local corner = Instance.new("UICorner") corner.CornerRadius = UDim.new(0, 7) corner.Parent = frame
    local label = Instance.new("TextLabel") label.Parent = frame label.BackgroundTransparency = 1 label.Position = UDim2.new(0.05, 0, 0, 0) label.Size = UDim2.new(0.62, 0, 1, 0) label.Font = Enum.Font.GothamBold label.Text = text label.TextColor3 = Color3.fromRGB(255, 255, 255) label.TextSize = 13 label.TextXAlignment = Enum.TextXAlignment.Left
    local toggle = Instance.new("TextButton") toggle.Parent = frame toggle.BackgroundColor3 = Color3.fromRGB(0, 60, 110) toggle.Position = UDim2.new(0.69, 0, 0.18, 0) toggle.Size = UDim2.new(0.26, 0, 0.64, 0) toggle.Font = Enum.Font.GothamBold toggle.Text = "OFF" toggle.TextColor3 = Color3.fromRGB(255, 80, 80) toggle.TextSize = 11
    local toggleCorner = Instance.new("UICorner") toggleCorner.CornerRadius = UDim.new(0, 5) toggleCorner.Parent = toggle
    return toggle, label
end

local function CreateInput(name, labelText, position, defaultValue)
    local frame = Instance.new("Frame") frame.Parent = ScrollFrame frame.BackgroundColor3 = Color3.fromRGB(0, 80, 140) frame.Position = position frame.Size = UDim2.new(0.9, 0, 0, 42)
    local corner = Instance.new("UICorner") corner.CornerRadius = UDim.new(0, 7) corner.Parent = frame
    local label = Instance.new("TextLabel") label.Parent = frame label.BackgroundTransparency = 1 label.Position = UDim2.new(0.05, 0, 0, 0) label.Size = UDim2.new(0.52, 0, 1, 0) label.Font = Enum.Font.GothamBold label.Text = labelText label.TextColor3 = Color3.fromRGB(255, 255, 255) label.TextSize = 12 label.TextXAlignment = Enum.TextXAlignment.Left
    local input = Instance.new("TextBox") input.Parent = frame input.BackgroundColor3 = Color3.fromRGB(0, 100, 180) input.Position = UDim2.new(0.59, 0, 0.18, 0) input.Size = UDim2.new(0.36, 0, 0.64, 0) input.Font = Enum.Font.Gotham input.Text = tostring(defaultValue) input.TextColor3 = Color3.fromRGB(255, 255, 255) input.TextSize = 13 input.ClearTextOnFocus = false
    local inputCorner = Instance.new("UICorner") inputCorner.CornerRadius = UDim.new(0, 5) inputCorner.Parent = input
    return input
end

local function CreateSectionLabel(text, position)
    local label = Instance.new("TextLabel") label.Parent = ScrollFrame label.BackgroundTransparency = 1 label.Position = position label.Size = UDim2.new(0.9, 0, 0, 22) label.Font = Enum.Font.GothamBold label.Text = text label.TextColor3 = Color3.fromRGB(100, 200, 255) label.TextSize = 12 label.TextXAlignment = Enum.TextXAlignment.Left
    return label
end

local function CreateSkillToggle(skillKey, position)
    local toggle = Instance.new("TextButton") toggle.Parent = ScrollFrame toggle.BackgroundColor3 = CONFIG.SelectedSkills[skillKey] and Color3.fromRGB(0, 120, 80) or Color3.fromRGB(0, 60, 110) toggle.Position = position toggle.Size = UDim2.new(0.2, 0, 0, 36) toggle.Font = Enum.Font.GothamBold toggle.Text = skillKey toggle.TextColor3 = CONFIG.SelectedSkills[skillKey] and Color3.fromRGB(80, 255, 80) or Color3.fromRGB(255, 80, 80) toggle.TextSize = 15
    local corner = Instance.new("UICorner") corner.CornerRadius = UDim.new(0, 7) corner.Parent = toggle
    return toggle
end

-- T·∫°o Controls
local yPos = 10
CreateSectionLabel("‚öôÔ∏è T√çNH NƒÇNG", UDim2.new(0.05, 0, 0, yPos)) yPos = yPos + 28
local AimToggle = CreateToggle("AimToggle", "üéØ Aim Assist", UDim2.new(0.05, 0, 0, yPos)) yPos = yPos + 48
local AntiToggle = CreateToggle("AntiToggle", "‚ö° Kh·∫Øc Runner", UDim2.new(0.05, 0, 0, yPos)) yPos = yPos + 48
local DashAntiStunToggle = CreateToggle("DashAntiStunToggle", "üí® Dash Anti-Stun", UDim2.new(0.05, 0, 0, yPos)) yPos = yPos + 58
CreateSectionLabel("‚öîÔ∏è CH·ªåN SKILL AUTO TP:", UDim2.new(0.05, 0, 0, yPos)) yPos = yPos + 28
local SkillR = CreateSkillToggle("R", UDim2.new(0.05, 0, 0, yPos))
local SkillT = CreateSkillToggle("T", UDim2.new(0.28, 0, 0, yPos))
local SkillF = CreateSkillToggle("F", UDim2.new(0.51, 0, 0, yPos))
local SkillG = CreateSkillToggle("G", UDim2.new(0.74, 0, 0, yPos)) yPos = yPos + 48
CreateSectionLabel("üîß C√ÄI ƒê·∫∂T", UDim2.new(0.05, 0, 0, yPos)) yPos = yPos + 28
local CharacterInput = CreateInput("CharacterInput", "üé≠ T∆∞·ªõng:", UDim2.new(0.05, 0, 0, yPos), CONFIG.SkillSuffix) yPos = yPos + 48
local RangeInput = CreateInput("RangeInput", "üìè Bubble Size:", UDim2.new(0.05, 0, 0, yPos), CONFIG.Range) yPos = yPos + 48
local TPDelayInput = CreateInput("TPDelayInput", "‚è±Ô∏è TP Delay:", UDim2.new(0.05, 0, 0, yPos), CONFIG.TeleportDelay) yPos = yPos + 48
local TPCooldownInput = CreateInput("TPCooldownInput", "‚è≥ TP CD:", UDim2.new(0.05, 0, 0, yPos), CONFIG.TeleportCooldown) yPos = yPos + 48
local SkillDelayInput = CreateInput("SkillDelayInput", "‚ö° Skill Delay:", UDim2.new(0.05, 0, 0, yPos), CONFIG.SkillDelay) yPos = yPos + 48
local BubbleInput = CreateInput("BubbleInput", "üíß Bubble:", UDim2.new(0.05, 0, 0, yPos), CONFIG.BubbleTransparency) yPos = yPos + 48
local AntiStunDurationInput = CreateInput("AntiStunDuration", "‚è≥ Anti-Stun Time:", UDim2.new(0.05, 0, 0, yPos), CONFIG.AntiStunDuration) yPos = yPos + 48
local AntiStunCooldownInput = CreateInput("AntiStunCooldown", "üîÑ Anti-Stun CD:", UDim2.new(0.05, 0, 0, yPos), CONFIG.AntiStunCooldown) yPos = yPos + 58
local Credit = Instance.new("TextLabel") Credit.Parent = ScrollFrame Credit.BackgroundTransparency = 1 Credit.Position = UDim2.new(0, 0, 0, yPos) Credit.Size = UDim2.new(1, 0, 0, 22) Credit.Font = Enum.Font.GothamBold Credit.Text = "Optimized + Anti-Stun CD ‚ö°" Credit.TextColor3 = Color3.fromRGB(150, 200, 255) Credit.TextSize = 10
ScrollFrame.CanvasSize = UDim2.new(0, 0, 0, yPos + 30)

-- --- T·∫†O VISUAL BUBBLE ---
local BubblePart = Instance.new("Part")
BubblePart.Name = "AimRangeBubble"
BubblePart.Shape = Enum.PartType.Ball
BubblePart.Material = Enum.Material.ForceField
BubblePart.Size = Vector3.new(CONFIG.Range * 2, CONFIG.Range * 2, CONFIG.Range * 2)
BubblePart.Color = CONFIG.BubbleColor
BubblePart.Transparency = 1
BubblePart.CanCollide = false
BubblePart.Anchored = true
BubblePart.CastShadow = false
BubblePart.Parent = workspace

-- --- H√ÄM T√åM M·ª§C TI√äU C·∫¢I TI·∫æN (T·ªêI ∆ØU) ---
local function GetClosestEnemy(searchRange)
    if not cachedCharacter or not cachedRootPart then return nil end
    
    local closestPlayer = nil
    local shortestDistance = searchRange
    local myPosition = cachedRootPart.Position
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Name ~= CONFIG.AllyName then
            local char = player.Character
            if char then
                local humanoid = char:FindFirstChild("Humanoid")
                local root = char:FindFirstChild("HumanoidRootPart")
                
                if humanoid and humanoid.Health > 0 and root then
                    local distance = (root.Position - myPosition).Magnitude
                    if distance < shortestDistance then
                        shortestDistance = distance
                        closestPlayer = char
                    end
                end
            end
        end
    end
    return closestPlayer
end

-- --- H√ÄM TH·ª∞C HI·ªÜN TELEPORT ---
local function ExecuteTeleport(target)
    if not target or not target:FindFirstChild("HumanoidRootPart") then return end
    if not cachedCharacter or not cachedRootPart then return end
    
    local targetCFrame = target.HumanoidRootPart.CFrame
    local backPosition = targetCFrame * CFrame.new(0, 0, 3)
    
    cachedRootPart.CFrame = CFrame.lookAt(backPosition.Position, target.HumanoidRootPart.Position)
    
    lastTeleportTime = tick()
    teleportCooldownRemaining = CONFIG.TeleportCooldown
    CooldownFrame.Visible = true
end

-- --- TELEPORT T·ª∞ ƒê·ªòNG ---
local function AutoTeleportToTarget()
    local currentTime = tick()
    if currentTime - lastTeleportTime < CONFIG.TeleportCooldown then return end
    
    task.wait(CONFIG.TeleportDelay)
    
    local target = GetClosestEnemy(CONFIG.Range + 5)
    if target then
        ExecuteTeleport(target)
    end
end

-- --- TELEPORT TH·ª¶ C√îNG ---
MobileTPBtn.MouseButton1Click:Connect(function()
    local currentTime = tick()
    if currentTime - lastTeleportTime < CONFIG.TeleportCooldown then 
        return 
    end
    
    local target = GetClosestEnemy(CONFIG.Range + 5)
    if target then
        ExecuteTeleport(target)
    end
end)

-- --- T·ªêI ∆ØU: CH·ªà HOOK KHI C·∫¶N THI·∫æT ---
local dashConnection = nil

local function SetupDashHook()
    if dashConnection then return end -- Tr√°nh hook nhi·ªÅu l·∫ßn
    
    local oldNamecall
    oldNamecall = hookmetamethod(game, "__namecall", function(self, ...)
        local args = {...}
        local method = getnamecallmethod()
        
        -- Ch·ªâ x·ª≠ l√Ω khi Anti-Stun ƒë∆∞·ª£c b·∫≠t
        if CONFIG.AntiStunEnabled and method == "FireServer" and self.Name == "Remote" and args[1] == "Dash" then
            TriggerAntiStun()
        end
        
        -- Auto Teleport Logic
        if method == "FireServer" and self.Name == "Remote" then
            if isAntiRunner and CONFIG.SelectedSkills[args[1]] then
                task.spawn(AutoTeleportToTarget)
            end
        end
        
        return oldNamecall(self, ...)
    end)
    
    dashConnection = true
end

-- Logic Toggle Buttons
AimToggle.MouseButton1Click:Connect(function()
    isAiming = not isAiming
    AimToggle.Text = isAiming and "ON" or "OFF"
    AimToggle.TextColor3 = isAiming and Color3.fromRGB(80, 255, 80) or Color3.fromRGB(255, 80, 80)
    AimToggle.BackgroundColor3 = isAiming and Color3.fromRGB(0, 120, 80) or Color3.fromRGB(0, 60, 110)
    BubblePart.Transparency = isAiming and CONFIG.BubbleTransparency or 1
end)

AntiToggle.MouseButton1Click:Connect(function()
    isAntiRunner = not isAntiRunner
    AntiToggle.Text = isAntiRunner and "ON" or "OFF"
    AntiToggle.TextColor3 = isAntiRunner and Color3.fromRGB(80, 255, 80) or Color3.fromRGB(255, 80, 80)
    AntiToggle.BackgroundColor3 = isAntiRunner and Color3.fromRGB(0, 120, 80) or Color3.fromRGB(0, 60, 110)
end)

DashAntiStunToggle.MouseButton1Click:Connect(function()
    CONFIG.AntiStunEnabled = not CONFIG.AntiStunEnabled
    DashAntiStunToggle.Text = CONFIG.AntiStunEnabled and "ON" or "OFF"
    DashAntiStunToggle.TextColor3 = CONFIG.AntiStunEnabled and Color3.fromRGB(80, 255, 80) or Color3.fromRGB(255, 80, 80)
    DashAntiStunToggle.BackgroundColor3 = CONFIG.AntiStunEnabled and Color3.fromRGB(0, 120, 80) or Color3.fromRGB(0, 60, 110)
    
    -- Ch·ªâ setup hook khi b·∫≠t Anti-Stun
    if CONFIG.AntiStunEnabled then
        SetupDashHook()
    end
end)

local function SetupSkillToggle(button, skillKey)
    button.MouseButton1Click:Connect(function()
        CONFIG.SelectedSkills[skillKey] = not CONFIG.SelectedSkills[skillKey]
        button.Text = skillKey
        button.TextColor3 = CONFIG.SelectedSkills[skillKey] and Color3.fromRGB(80, 255, 80) or Color3.fromRGB(255, 80, 80)
        button.BackgroundColor3 = CONFIG.SelectedSkills[skillKey] and Color3.fromRGB(0, 120, 80) or Color3.fromRGB(0, 60, 110)
    end)
end
SetupSkillToggle(SkillR, "R") SetupSkillToggle(SkillT, "T") SetupSkillToggle(SkillF, "F") SetupSkillToggle(SkillG, "G")

-- Input Handlers
CharacterInput.FocusLost:Connect(function()
    local newName = CharacterInput.Text:gsub("^%s*(.-)%s*$", "%1")
    if newName == "" then CharacterInput.Text = CONFIG.SkillSuffix return end
    if not newName:find("Kamen Rider") then CONFIG.SkillSuffix = newName else CONFIG.SkillSuffix = newName:gsub("Kamen Rider ", "") end
    CharacterInput.Text = CONFIG.SkillSuffix
end)

RangeInput.FocusLost:Connect(function()
    local newRange = tonumber(RangeInput.Text)
    if newRange and newRange > 0 then
        CONFIG.Range = newRange
        BubblePart.Size = Vector3.new(newRange * 2, newRange * 2, newRange * 2)
    else
        RangeInput.Text = tostring(CONFIG.Range)
    end
end)

TPDelayInput.FocusLost:Connect(function() 
    local v = tonumber(TPDelayInput.Text) 
    if v and v >= 0 then CONFIG.TeleportDelay = v else TPDelayInput.Text = tostring(CONFIG.TeleportDelay) end 
end)

TPCooldownInput.FocusLost:Connect(function() 
    local v = tonumber(TPCooldownInput.Text) 
    if v and v >= 0 then CONFIG.TeleportCooldown = v else TPCooldownInput.Text = tostring(CONFIG.TeleportCooldown) end 
end)

SkillDelayInput.FocusLost:Connect(function() 
    local v = tonumber(SkillDelayInput.Text) 
    if v and v >= 0 then CONFIG.SkillDelay = v else SkillDelayInput.Text = tostring(CONFIG.SkillDelay) end 
end)

BubbleInput.FocusLost:Connect(function() 
    local v = tonumber(BubbleInput.Text) 
    if v and v >= 0 and v <= 1 then 
        CONFIG.BubbleTransparency = v 
        if isAiming then BubblePart.Transparency = v end 
    else 
        BubbleInput.Text = tostring(CONFIG.BubbleTransparency) 
    end 
end)

AntiStunDurationInput.FocusLost:Connect(function() 
    local v = tonumber(AntiStunDurationInput.Text) 
    if v and v > 0 then CONFIG.AntiStunDuration = v else AntiStunDurationInput.Text = tostring(CONFIG.AntiStunDuration) end 
end)

AntiStunCooldownInput.FocusLost:Connect(function() 
    local v = tonumber(AntiStunCooldownInput.Text) 
    if v and v > 0 then CONFIG.AntiStunCooldown = v else AntiStunCooldownInput.Text = tostring(CONFIG.AntiStunCooldown) end 
end)

-- --- C·∫¨P NH·∫¨T CACHE CHARACTER ---
local function UpdateCharacterCache()
    cachedCharacter = LocalPlayer.Character
    if cachedCharacter then
        cachedRootPart = cachedCharacter:FindFirstChild("HumanoidRootPart")
        cachedHumanoid = cachedCharacter:FindFirstChildOfClass("Humanoid")
    else
        cachedRootPart = nil
        cachedHumanoid = nil
    end
end

-- C·∫≠p nh·∫≠t cache khi character thay ƒë·ªïi
LocalPlayer.CharacterAdded:Connect(function()
    task.wait(0.1)
    UpdateCharacterCache()
end)

UpdateCharacterCache()

-- --- V√íNG L·∫∂P CH√çNH (T·ªêI ∆ØU) ---
local lastUpdate = tick()
local updateInterval = 0.016 -- ~60 FPS

RunService.RenderStepped:Connect(function(deltaTime)
    local currentTime = tick()
    
    -- C·∫≠p nh·∫≠t cache n·∫øu c·∫ßn
    if not cachedCharacter or not cachedRootPart then
        UpdateCharacterCache()
        if not cachedRootPart then
            BubblePart.Position = Vector3.new(0, -1000, 0)
            return
        end
    end
    
    -- C·∫≠p nh·∫≠t v·ªã tr√≠ bubble
    BubblePart.Position = cachedRootPart.Position
    
    -- C·∫≠p nh·∫≠t TP Cooldown
    if teleportCooldownRemaining > 0 then
        teleportCooldownRemaining = math.max(0, teleportCooldownRemaining - deltaTime)
        CooldownTimer.Text = string.format("%.1fs", teleportCooldownRemaining)
        if teleportCooldownRemaining <= 0 then 
            CooldownFrame.Visible = false 
        end
    end
    
    -- C·∫≠p nh·∫≠t Anti-Stun Cooldown
    if antiStunCooldownRemaining > 0 then
        antiStunCooldownRemaining = math.max(0, antiStunCooldownRemaining - deltaTime)
        AntiStunTimer.Text = string.format("%.1fs", antiStunCooldownRemaining)
        AntiStunFrame.Visible = true
        
        -- ƒê·ªïi m√†u khi active
        if isAntiStunActive then
            AntiStunFrame.BackgroundColor3 = Color3.fromRGB(0, 160, 90) -- Xanh l√° khi ƒëang ho·∫°t ƒë·ªông
        else
            AntiStunFrame.BackgroundColor3 = Color3.fromRGB(160, 90, 0) -- Cam khi ƒëang cooldown
        end
        
        if antiStunCooldownRemaining <= 0 then 
            AntiStunFrame.Visible = false 
        end
    end
    
    -- Aim Assist (throttle ƒë·ªÉ gi·∫£m lag)
    if isAiming and currentTime - lastUpdate >= updateInterval then
        lastUpdate = currentTime
        local target = GetClosestEnemy(CONFIG.Range + 5)
        if target and target:FindFirstChild("HumanoidRootPart") then
            local targetPos = target.HumanoidRootPart.Position
            local myPos = cachedRootPart.Position
            cachedRootPart.CFrame = CFrame.lookAt(myPos, Vector3.new(targetPos.X, myPos.Y, targetPos.Z))
        end
    end
end)
