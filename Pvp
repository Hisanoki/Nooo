local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer

-- --- Cáº¤U HÃŒNH ---
local CONFIG = {
    Range = 40,
    AllyName = "GrahamScyther",
    BubbleColor = Color3.fromRGB(0, 170, 255),
    BubbleTransparency = 0.6,
    SkillPrefix = "Kamen Rider",
    SkillSuffix = "Chalice",
    DashDelay = 0.2,
    TeleportDelay = 0.3,
    TeleportCooldown = 5,
    SelectedSkills = {
        R = true,
        T = false,
        X = false,
        G = false
    }
}

-- --- BIáº¾N TRáº NG THÃI ---
local isAiming = false
local isAntiRunner = false
local isTeleportEnabled = false
local currentTarget = nil
local lastTeleportTime = 0
local teleportCooldownRemaining = 0

-- --- Táº O GUI HIá»†N Äáº I ---
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ModernAimGUI"
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
ScreenGui.ResetOnSpawn = false

-- Main Frame (cÃ³ thá»ƒ kÃ©o) - TÄƒng chiá»u cao Ä‘á»ƒ chá»©a thÃªm UI
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
MainFrame.Position = UDim2.new(0.5, -160, 0.2, 0)
MainFrame.Size = UDim2.new(0, 320, 0, 550) -- TÄƒng tá»« 420 lÃªn 550
MainFrame.Active = true
MainFrame.Draggable = true

local MainCorner = Instance.new("UICorner")
MainCorner.CornerRadius = UDim.new(0, 12)
MainCorner.Parent = MainFrame

local MainStroke = Instance.new("UIStroke")
MainStroke.Color = Color3.fromRGB(0, 170, 255)
MainStroke.Thickness = 2
MainStroke.Parent = MainFrame

-- Header
local Header = Instance.new("TextLabel")
Header.Parent = MainFrame
Header.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
Header.Size = UDim2.new(1, 0, 0, 45)
Header.Font = Enum.Font.GothamBold
Header.Text = "ðŸŽ¯ AIM ASSIST PRO"
Header.TextColor3 = Color3.fromRGB(255, 255, 255)
Header.TextSize = 18

local HeaderCorner = Instance.new("UICorner")
HeaderCorner.CornerRadius = UDim.new(0, 12)
HeaderCorner.Parent = Header

-- NÃºt Ä‘Ã³ng/má»Ÿ GUI
local ToggleBtn = Instance.new("TextButton")
ToggleBtn.Parent = ScreenGui
ToggleBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
ToggleBtn.Position = UDim2.new(0.02, 0, 0.5, 0)
ToggleBtn.Size = UDim2.new(0, 50, 0, 50)
ToggleBtn.Font = Enum.Font.GothamBold
ToggleBtn.Text = "â˜°"
ToggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleBtn.TextSize = 24

local ToggleCorner = Instance.new("UICorner")
ToggleCorner.CornerRadius = UDim.new(0, 25)
ToggleCorner.Parent = ToggleBtn

local guiVisible = true
ToggleBtn.MouseButton1Click:Connect(function()
    guiVisible = not guiVisible
    MainFrame.Visible = guiVisible
    ToggleBtn.Text = guiVisible and "â˜°" or "+"
end)

-- Cooldown Timer Display
local CooldownFrame = Instance.new("Frame")
CooldownFrame.Parent = ScreenGui
CooldownFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
CooldownFrame.Position = UDim2.new(0.02, 0, 0.1, 0)
CooldownFrame.Size = UDim2.new(0, 100, 0, 60)
CooldownFrame.Visible = false

local CooldownCorner = Instance.new("UICorner")
CooldownCorner.CornerRadius = UDim.new(0, 10)
CooldownCorner.Parent = CooldownFrame

local CooldownLabel = Instance.new("TextLabel")
CooldownLabel.Parent = CooldownFrame
CooldownLabel.BackgroundTransparency = 1
CooldownLabel.Size = UDim2.new(1, 0, 0.5, 0)
CooldownLabel.Font = Enum.Font.GothamBold
CooldownLabel.Text = "DASH CD"
CooldownLabel.TextColor3 = Color3.fromRGB(255, 170, 0)
CooldownLabel.TextSize = 14

local CooldownTimer = Instance.new("TextLabel")
CooldownTimer.Parent = CooldownFrame
CooldownTimer.BackgroundTransparency = 1
CooldownTimer.Position = UDim2.new(0, 0, 0.5, 0)
CooldownTimer.Size = UDim2.new(1, 0, 0.5, 0)
CooldownTimer.Font = Enum.Font.GothamBold
CooldownTimer.Text = "0.0s"
CooldownTimer.TextColor3 = Color3.fromRGB(255, 255, 255)
CooldownTimer.TextSize = 20

-- HÃ m táº¡o Toggle Button
local function CreateToggle(name, text, position, color)
    local frame = Instance.new("Frame")
    frame.Parent = MainFrame
    frame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
    frame.Position = position
    frame.Size = UDim2.new(0.9, 0, 0, 50)
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = frame
    
    local label = Instance.new("TextLabel")
    label.Parent = frame
    label.BackgroundTransparency = 1
    label.Position = UDim2.new(0.05, 0, 0, 0)
    label.Size = UDim2.new(0.65, 0, 1, 0)
    label.Font = Enum.Font.GothamBold
    label.Text = text
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextSize = 14
    label.TextXAlignment = Enum.TextXAlignment.Left
    
    local toggle = Instance.new("TextButton")
    toggle.Parent = frame
    toggle.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
    toggle.Position = UDim2.new(0.72, 0, 0.2, 0)
    toggle.Size = UDim2.new(0.23, 0, 0.6, 0)
    toggle.Font = Enum.Font.GothamBold
    toggle.Text = "OFF"
    toggle.TextColor3 = Color3.fromRGB(255, 80, 80)
    toggle.TextSize = 12
    
    local toggleCorner = Instance.new("UICorner")
    toggleCorner.CornerRadius = UDim.new(0, 6)
    toggleCorner.Parent = toggle
    
    return toggle, label
end

-- HÃ m táº¡o Input Box
local function CreateInput(name, labelText, position, defaultValue)
    local frame = Instance.new("Frame")
    frame.Parent = MainFrame
    frame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
    frame.Position = position
    frame.Size = UDim2.new(0.9, 0, 0, 50)
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = frame
    
    local label = Instance.new("TextLabel")
    label.Parent = frame
    label.BackgroundTransparency = 1
    label.Position = UDim2.new(0.05, 0, 0, 0)
    label.Size = UDim2.new(0.55, 0, 1, 0)
    label.Font = Enum.Font.GothamBold
    label.Text = labelText
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextSize = 13
    label.TextXAlignment = Enum.TextXAlignment.Left
    
    local input = Instance.new("TextBox")
    input.Parent = frame
    input.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
    input.Position = UDim2.new(0.62, 0, 0.2, 0)
    input.Size = UDim2.new(0.33, 0, 0.6, 0)
    input.Font = Enum.Font.Gotham
    input.Text = tostring(defaultValue)
    input.TextColor3 = Color3.fromRGB(255, 255, 255)
    input.TextSize = 14
    input.ClearTextOnFocus = false
    
    local inputCorner = Instance.new("UICorner")
    inputCorner.CornerRadius = UDim.new(0, 6)
    inputCorner.Parent = input
    
    return input
end

-- HÃ m táº¡o Skill Toggle (nhá» hÆ¡n, Ä‘á»ƒ 4 nÃºt cáº¡nh nhau)
local function CreateSkillToggle(skillKey, position)
    local toggle = Instance.new("TextButton")
    toggle.Parent = MainFrame
    toggle.BackgroundColor3 = CONFIG.SelectedSkills[skillKey] and Color3.fromRGB(40, 100, 40) or Color3.fromRGB(60, 60, 65)
    toggle.Position = position
    toggle.Size = UDim2.new(0.2, 0, 0, 40)
    toggle.Font = Enum.Font.GothamBold
    toggle.Text = skillKey
    toggle.TextColor3 = CONFIG.SelectedSkills[skillKey] and Color3.fromRGB(80, 255, 80) or Color3.fromRGB(255, 80, 80)
    toggle.TextSize = 16
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = toggle
    
    return toggle
end

-- Táº¡o cÃ¡c controls
local AimToggle = CreateToggle("AimToggle", "ðŸŽ¯ Aim Assist", UDim2.new(0.05, 0, 0, 60))
local AntiToggle = CreateToggle("AntiToggle", "âš¡ Kháº¯c Runner", UDim2.new(0.05, 0, 0, 120))
local TeleToggle = CreateToggle("TeleToggle", "ðŸ‘» Biáº¿n áº¢o", UDim2.new(0.05, 0, 0, 180))

-- ThÃªm Label cho Skill Selection
local SkillLabel = Instance.new("TextLabel")
SkillLabel.Parent = MainFrame
SkillLabel.BackgroundTransparency = 1
SkillLabel.Position = UDim2.new(0.05, 0, 0, 240)
SkillLabel.Size = UDim2.new(0.9, 0, 0, 25)
SkillLabel.Font = Enum.Font.GothamBold
SkillLabel.Text = "âš”ï¸ Chá»n Skill Auto Dash:"
SkillLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
SkillLabel.TextSize = 13
SkillLabel.TextXAlignment = Enum.TextXAlignment.Left

-- Táº¡o cÃ¡c nÃºt chá»n skill (4 nÃºt cáº¡nh nhau)
local SkillR = CreateSkillToggle("R", UDim2.new(0.05, 0, 0, 270))
local SkillT = CreateSkillToggle("T", UDim2.new(0.28, 0, 0, 270))
local SkillX = CreateSkillToggle("X", UDim2.new(0.51, 0, 0, 270))
local SkillG = CreateSkillToggle("G", UDim2.new(0.74, 0, 0, 270))

-- ThÃªm TextBox Ä‘á»ƒ nháº­p tÃªn tÆ°á»›ng
local CharacterInput = CreateInput("CharacterInput", "ðŸŽ­ TÃªn TÆ°á»›ng:", UDim2.new(0.05, 0, 0, 330), CONFIG.SkillSuffix)

local RangeInput = CreateInput("RangeInput", "ðŸ“ Range:", UDim2.new(0.05, 0, 0, 390), CONFIG.Range)
local BubbleInput = CreateInput("BubbleInput", "ðŸ’§ Bubble Alpha:", UDim2.new(0.05, 0, 0, 450), CONFIG.BubbleTransparency)

-- Credit
local Credit = Instance.new("TextLabel")
Credit.Parent = MainFrame
Credit.BackgroundTransparency = 1
Credit.Position = UDim2.new(0, 0, 1, -30)
Credit.Size = UDim2.new(1, 0, 0, 25)
Credit.Font = Enum.Font.GothamBold
Credit.Text = "Made for Mobile ðŸ“±"
Credit.TextColor3 = Color3.fromRGB(150, 150, 155)
Credit.TextSize = 11

-- --- HÃ€M TÃŒM REMOTE ---
local function GetSkillRemote()
    local fullName = CONFIG.SkillPrefix .. " " .. CONFIG.SkillSuffix
    local tool = LocalPlayer.Backpack:FindFirstChild(fullName) or LocalPlayer.Character:FindFirstChild(fullName)
    if tool then
        return tool:FindFirstChild("Remote")
    end
    return nil
end

-- --- Táº O VISUAL BUBBLE ---
local BubblePart = Instance.new("Part")
BubblePart.Name = "AimRangeBubble"
BubblePart.Shape = Enum.PartType.Ball
BubblePart.Material = Enum.Material.ForceField
BubblePart.Size = Vector3.new(CONFIG.Range * 2, CONFIG.Range * 2, CONFIG.Range * 2)
BubblePart.Color = CONFIG.BubbleColor
BubblePart.Transparency = 1
BubblePart.CanCollide = false
BubblePart.Anchored = true
BubblePart.CastShadow = false
BubblePart.Parent = workspace

-- --- HÃ€M TÃŒM Má»¤C TIÃŠU ---
local function GetClosestEnemy()
    local closestPlayer = nil
    local shortestDistance = CONFIG.Range
    local myCharacter = LocalPlayer.Character
    if not myCharacter or not myCharacter:FindFirstChild("HumanoidRootPart") then return nil end
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Name ~= CONFIG.AllyName and player.Character and player.Character:FindFirstChild("Humanoid") and player.Character.Humanoid.Health > 0 then
            local root = player.Character:FindFirstChild("HumanoidRootPart")
            if root then
                local distance = (root.Position - myCharacter.HumanoidRootPart.Position).Magnitude
                if distance < shortestDistance then
                    shortestDistance = distance
                    closestPlayer = player.Character
                end
            end
        end
    end
    return closestPlayer
end

-- --- TELEPORT KHI DASH ---
local function OnDashUsed()
    if not isTeleportEnabled then return end
    
    local currentTime = tick()
    if currentTime - lastTeleportTime < CONFIG.TeleportCooldown then
        return
    end
    
    task.wait(CONFIG.TeleportDelay)
    
    local target = GetClosestEnemy()
    if target and target:FindFirstChild("HumanoidRootPart") then
        local myChar = LocalPlayer.Character
        if myChar and myChar:FindFirstChild("HumanoidRootPart") then
            local targetCFrame = target.HumanoidRootPart.CFrame
            local frontPosition = targetCFrame * CFrame.new(0, 0, -5)
            
            myChar.HumanoidRootPart.CFrame = CFrame.new(frontPosition.Position, target.HumanoidRootPart.Position)
            
            lastTeleportTime = tick()
            teleportCooldownRemaining = CONFIG.TeleportCooldown
            CooldownFrame.Visible = true
        end
    end
end

-- --- AUTO DASH SAU KHI DÃ™NG SKILL ---
local function AutoDashAfterSkill()
    task.wait(CONFIG.DashDelay)
    local remote = GetSkillRemote()
    if remote then
        remote:FireServer("Dash")
    end
end

-- Hook vÃ o Remote
local oldNamecall
oldNamecall = hookmetamethod(game, "__namecall", function(self, ...)
    local args = {...}
    local method = getnamecallmethod()
    
    if method == "FireServer" and self.Name == "Remote" then
        if args[1] == "Dash" then
            task.spawn(OnDashUsed)
        end
        
        -- Kiá»ƒm tra náº¿u skill Ä‘Æ°á»£c chá»n vÃ  Anti-Runner Ä‘ang báº­t
        if isAntiRunner and CONFIG.SelectedSkills[args[1]] then
            task.spawn(AutoDashAfterSkill)
        end
    end
    
    return oldNamecall(self, ...)
end)

-- --- LOGIC NÃšT Báº¤M ---
AimToggle.MouseButton1Click:Connect(function()
    isAiming = not isAiming
    AimToggle.Text = isAiming and "ON" or "OFF"
    AimToggle.TextColor3 = isAiming and Color3.fromRGB(80, 255, 80) or Color3.fromRGB(255, 80, 80)
    AimToggle.BackgroundColor3 = isAiming and Color3.fromRGB(40, 100, 40) or Color3.fromRGB(60, 60, 65)
    BubblePart.Transparency = isAiming and CONFIG.BubbleTransparency or 1
end)

AntiToggle.MouseButton1Click:Connect(function()
    isAntiRunner = not isAntiRunner
    AntiToggle.Text = isAntiRunner and "ON" or "OFF"
    AntiToggle.TextColor3 = isAntiRunner and Color3.fromRGB(80, 255, 80) or Color3.fromRGB(255, 80, 80)
    AntiToggle.BackgroundColor3 = isAntiRunner and Color3.fromRGB(40, 100, 40) or Color3.fromRGB(60, 60, 65)
end)

TeleToggle.MouseButton1Click:Connect(function()
    isTeleportEnabled = not isTeleportEnabled
    TeleToggle.Text = isTeleportEnabled and "ON" or "OFF"
    TeleToggle.TextColor3 = isTeleportEnabled and Color3.fromRGB(80, 255, 80) or Color3.fromRGB(255, 80, 80)
    TeleToggle.BackgroundColor3 = isTeleportEnabled and Color3.fromRGB(40, 100, 40) or Color3.fromRGB(60, 60, 65)
end)

-- Logic cho cÃ¡c nÃºt skill
local function SetupSkillToggle(button, skillKey)
    button.MouseButton1Click:Connect(function()
        CONFIG.SelectedSkills[skillKey] = not CONFIG.SelectedSkills[skillKey]
        button.Text = skillKey
        button.TextColor3 = CONFIG.SelectedSkills[skillKey] and Color3.fromRGB(80, 255, 80) or Color3.fromRGB(255, 80, 80)
        button.BackgroundColor3 = CONFIG.SelectedSkills[skillKey] and Color3.fromRGB(40, 100, 40) or Color3.fromRGB(60, 60, 65)
    end)
end

SetupSkillToggle(SkillR, "R")
SetupSkillToggle(SkillT, "T")
SetupSkillToggle(SkillX, "X")
SetupSkillToggle(SkillG, "G")

-- Cáº­p nháº­t tÃªn tÆ°á»›ng
CharacterInput.FocusLost:Connect(function()
    local newName = CharacterInput.Text:gsub("^%s*(.-)%s*$", "%1") -- Trim whitespace
    
    if newName == "" then
        CharacterInput.Text = CONFIG.SkillSuffix
        return
    end
    
    -- Kiá»ƒm tra xem cÃ³ chá»©a "Kamen Rider" khÃ´ng
    if not newName:find("Kamen Rider") then
        -- Náº¿u khÃ´ng cÃ³, thÃ¬ chá»‰ láº¥y pháº§n sau (tÃªn tÆ°á»›ng)
        CONFIG.SkillSuffix = newName
    else
        -- Náº¿u cÃ³ "Kamen Rider", tÃ¡ch ra
        CONFIG.SkillSuffix = newName:gsub("Kamen Rider ", "")
    end
    
    CharacterInput.Text = CONFIG.SkillSuffix
    print("âœ… ÄÃ£ Ä‘á»•i tÆ°á»›ng thÃ nh: " .. CONFIG.SkillPrefix .. " " .. CONFIG.SkillSuffix)
end)

-- Cáº­p nháº­t Range
RangeInput.FocusLost:Connect(function()
    local newRange = tonumber(RangeInput.Text)
    if newRange and newRange > 0 then
        CONFIG.Range = newRange
        BubblePart.Size = Vector3.new(newRange * 2, newRange * 2, newRange * 2)
    else
        RangeInput.Text = tostring(CONFIG.Range)
    end
end)

-- Cáº­p nháº­t Bubble Transparency
BubbleInput.FocusLost:Connect(function()
    local newTrans = tonumber(BubbleInput.Text)
    if newTrans and newTrans >= 0 and newTrans <= 1 then
        CONFIG.BubbleTransparency = newTrans
        if isAiming then
            BubblePart.Transparency = newTrans
        end
    else
        BubbleInput.Text = tostring(CONFIG.BubbleTransparency)
    end
end)

-- --- VÃ’NG Láº¶P CHÃNH ---
RunService.RenderStepped:Connect(function()
    local char = LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then
        BubblePart.Position = Vector3.new(0, -1000, 0)
        return
    end
    
    BubblePart.Position = char.HumanoidRootPart.Position
    
    if teleportCooldownRemaining > 0 then
        teleportCooldownRemaining = math.max(0, teleportCooldownRemaining - RunService.RenderStepped:Wait())
        CooldownTimer.Text = string.format("%.1fs", teleportCooldownRemaining)
        if teleportCooldownRemaining <= 0 then
            CooldownFrame.Visible = false
        end
    end
    
    if isAiming then
        local target = GetClosestEnemy()
        if target and target:FindFirstChild("HumanoidRootPart") then
            local targetPos = target.HumanoidRootPart.Position
            local myPos = char.HumanoidRootPart.Position
            char.HumanoidRootPart.CFrame = CFrame.lookAt(myPos, Vector3.new(targetPos.X, myPos.Y, targetPos.Z))
        end
    end
end)
