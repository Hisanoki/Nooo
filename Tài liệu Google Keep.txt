-- SERVICES
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer


-- CONFIG
local DEFAULT_HITBOX_SIZE = 4
local processedNPCs = {}
local respawnWatchers = {}
local autoHitboxEnabled = false
local connections = {}


-- GUI
local gui = Instance.new("ScreenGui")
gui.Name = "NPC_Hitbox_GUI"
gui.ResetOnSpawn = false
gui.Parent = game.CoreGui


local function createButton(parent,text,pos,color)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0,220,0,30)
    btn.Position = pos
    btn.Text = text
    btn.BackgroundColor3 = color
    btn.TextColor3 = Color3.new(1,1,1)
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 14
    btn.Parent = parent
    return btn
end


local toggleMenu = createButton(gui,"Show Menu",UDim2.new(0,10,0,10),Color3.fromRGB(50,50,50))
toggleMenu.Size = UDim2.new(0,100,0,35)


local frame = Instance.new("Frame")
frame.Size = UDim2.new(0,250,0,200)
frame.Position = UDim2.new(0,10,0,60)
frame.BackgroundColor3 = Color3.fromRGB(25,25,25)
frame.Visible = false
frame.Active = true
frame.Draggable = true
frame.Parent = gui


local title = Instance.new("TextLabel",frame)
title.Size = UDim2.new(1,0,0,30)
title.BackgroundColor3 = Color3.fromRGB(35,35,35)
title.Text = "NPC Head Hitbox Manager"
title.TextColor3 = Color3.new(1,1,1)
title.Font = Enum.Font.GothamBold
title.TextSize = 14


local sizeInput = Instance.new("TextBox",frame)
sizeInput.Size = UDim2.new(0,220,0,30)
sizeInput.Position = UDim2.new(0,15,0,40)
sizeInput.PlaceholderText = "Size (e.g. 4)"
sizeInput.Text = tostring(DEFAULT_HITBOX_SIZE)
sizeInput.BackgroundColor3 = Color3.fromRGB(60,60,60)
sizeInput.TextColor3 = Color3.new(1,1,1)
sizeInput.Font = Enum.Font.Gotham
sizeInput.TextSize = 14


local autoToggle = createButton(frame,"Auto Hitbox: OFF",UDim2.new(0,15,0,80),Color3.fromRGB(100,0,0))
local removeAllBtn = createButton(frame,"Remove All Hitboxes",UDim2.new(0,15,0,120),Color3.fromRGB(100,0,0))


local statusLabel = Instance.new("TextLabel",frame)
statusLabel.Size = UDim2.new(1,-10,0,20)
statusLabel.Position = UDim2.new(0,5,0,160)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "Processing: 0 NPCs"
statusLabel.TextColor3 = Color3.new(0,1,0)
statusLabel.Font = Enum.Font.Gotham
statusLabel.TextSize = 12
statusLabel.TextXAlignment = Enum.TextXAlignment.Left


-- UTILS
local function updateStatus()
    local count = 0
    for _ in pairs(processedNPCs) do count = count + 1 end
    statusLabel.Text = "Processing: "..count.." NPCs"
end


local function disconnectList(list)
    if not list then return end
    for _,c in ipairs(list) do
        pcall(function() c:Disconnect() end)
    end
end


-- CHECK VALID NPC
local function isValidNPC(model)
    if not model:IsA("Model") then return false end
    if model == LocalPlayer.Character then return false end
    if Players:GetPlayerFromCharacter(model) then return false end
    local hum = model:FindFirstChildOfClass("Humanoid")
    local root = model:FindFirstChild("HumanoidRootPart")
    if not hum or not root then return false end
    return true
end


-- BODY ESP
local function addBodyESP(npc)
    if npc:FindFirstChild("NPCBodyESP") then return npc.NPCBodyESP end
    local root = npc:FindFirstChild("HumanoidRootPart")
    if not root then return end


    local box = Instance.new("BoxHandleAdornment")
    box.Name = "NPCBodyESP"
    box.Adornee = root
    box.Size = root.Size + Vector3.new(4,4,4)
    box.Color3 = Color3.fromRGB(255,100,100)
    box.Transparency = 0.5
    box.ZIndex = 5
    box.AlwaysOnTop = true
    box.Parent = npc
    return box
end


-- REMOVE HITBOX
function removeHeadHitbox(npc)
    if not npc or not processedNPCs[npc] then return end
    local head = npc:FindFirstChild("Head")


    if processedNPCs[npc].connections then
        disconnectList(processedNPCs[npc].connections)
    end


    if head and head:FindFirstChild("OriginalSize") then
        local originalSize = head.OriginalSize.Value
        head.Size = originalSize
        head.OriginalSize:Destroy()


        head.Massless = false
        head.CanCollide = true
        head.Transparency = 0
        head.Material = Enum.Material.Plastic


        local mesh = head:FindFirstChild("Mesh")
        if mesh then
            mesh.MeshType = Enum.MeshType.Head
            mesh.Scale = Vector3.new(1,1,1)
        end
    end


    if processedNPCs[npc].esp then
        processedNPCs[npc].esp:Destroy()
    end


    processedNPCs[npc] = nil
    updateStatus()
end


-- APPLY HITBOX
function applyHeadHitbox(npc,size)
    if not isValidNPC(npc) then return end
    if processedNPCs[npc] then return end
    if respawnWatchers[npc] then
        disconnectList(respawnWatchers[npc])
        respawnWatchers[npc] = nil
    end


    local head = npc:FindFirstChild("Head")
    local root = npc:FindFirstChild("HumanoidRootPart")
    local hum = npc:FindFirstChildOfClass("Humanoid")


    if not head and root then
        head = Instance.new("Part")
        head.Name = "Head"
        head.Size = Vector3.new(2,1,1)
        head.CFrame = root.CFrame * CFrame.new(0, root.Size.Y/2 + 1, 0)
        head.Anchored = false
        head.CanCollide = false
        head.Massless = true
        head.Transparency = 1
        head.Parent = npc


        local weld = Instance.new("WeldConstraint")
        weld.Part0 = root
        weld.Part1 = head
        weld.Parent = head
    end


    if not head then return end
    if hum and hum.Health and hum.Health <=0 then return end


    if not head:FindFirstChild("Mesh") then
        local mesh = Instance.new("SpecialMesh")
        mesh.MeshType = Enum.MeshType.Head
        mesh.Scale = Vector3.new(1,1,1)
        mesh.Name = "Mesh"
        mesh.Parent = head
    end


    if not head:FindFirstChild("OriginalSize") then
        local original = Instance.new("Vector3Value")
        original.Name = "OriginalSize"
        original.Value = head.Size
        original.Parent = head
    end


    head.Massless = true
    head.Size = Vector3.new(size,size,size)
    head.CanCollide = false
    head.Transparency = 0.7
    head.Material = Enum.Material.ForceField


    local npcConns = {}
    table.insert(npcConns, head:GetPropertyChangedSignal("Size"):Connect(function()
        if processedNPCs[npc] then
            local wanted = Vector3.new(size,size,size)
            if head.Size ~= wanted then
                head.Size = wanted
            end
        end
    end))


    if hum then
        table.insert(npcConns, hum.Died:Connect(function()
            removeHeadHitbox(npc)
        end))
    end


    local esp = addBodyESP(npc)


    processedNPCs[npc] = {connections=npcConns,esp=esp}
    updateStatus()
end


-- SCAN
local function scanWorkspace()
    local size = tonumber(sizeInput.Text) or DEFAULT_HITBOX_SIZE
    for _,v in ipairs(workspace:GetDescendants()) do
        if isValidNPC(v) then
            applyHeadHitbox(v,size)
        end
    end
end


-- TRY APPLY
local function tryApplyModel(model)
    task.delay(0.2,function()
        if isValidNPC(model) then
            local size = tonumber(sizeInput.Text) or DEFAULT_HITBOX_SIZE
            applyHeadHitbox(model,size)
        end
    end)
end


-- AUTO TOGGLE
autoToggle.MouseButton1Click:Connect(function()
    autoHitboxEnabled = not autoHitboxEnabled
    autoToggle.Text = autoHitboxEnabled and "Auto Hitbox: ON" or "Auto Hitbox: OFF"
    autoToggle.BackgroundColor3 = autoHitboxEnabled and Color3.fromRGB(0,100,0) or Color3.fromRGB(100,0,0)
    for _,conn in ipairs(connections) do pcall(function() conn:Disconnect() end) end
    table.clear(connections)
    if autoHitboxEnabled then
        scanWorkspace()
        table.insert(connections, workspace.DescendantAdded:Connect(function(desc)
            local model = desc:FindFirstAncestorOfClass("Model")
            if model then tryApplyModel(model) end
        end))
        table.insert(connections, workspace.ChildAdded:Connect(function(child)
            if child:IsA("Model") then tryApplyModel(child) end
        end))
    end
end)


-- TOGGLE UI
toggleMenu.MouseButton1Click:Connect(function()
    frame.Visible = not frame.Visible
    toggleMenu.Text = frame.Visible and "Hide Menu" or "Show Menu"
end)


-- REMOVE ALL
local function clearAll()
    for npc,_ in pairs(processedNPCs) do removeHeadHitbox(npc) end
    for npc,conns in pairs(respawnWatchers) do
        disconnectList(conns)
        respawnWatchers[npc] = nil
    end
end


removeAllBtn.MouseButton1Click:Connect(function() clearAll() end)


-- CHARACTER RELOAD
LocalPlayer.CharacterAdded:Connect(function()
    task.wait(2)
    if autoHitboxEnabled then scanWorkspace() end
end)