local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")

-- Cấu hình
local ANTI_STUN_ENABLED = false
local MANUAL_ANTI_STUN_DURATION = 0.2
local COOLDOWN_TIME = 3
local KEYBIND = Enum.KeyCode.NumberOne
local TOGGLE_GUI_KEY = Enum.KeyCode.RightControl -- Phím toggle GUI

local isOnCooldown = false
local isManualAntiStunActive = false
local guiVisible = true

-- Tạo GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AntiStunGUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

-- Nút Toggle GUI (nhỏ, có thể di chuyển)
local ToggleGUIButton = Instance.new("TextButton")
ToggleGUIButton.Name = "ToggleGUIButton"
ToggleGUIButton.Size = UDim2.new(0, 50, 0, 50)
ToggleGUIButton.Position = UDim2.new(0, 10, 0.5, -25)
ToggleGUIButton.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
ToggleGUIButton.BorderSizePixel = 0
ToggleGUIButton.Font = Enum.Font.GothamBold
ToggleGUIButton.Text = "AS"
ToggleGUIButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleGUIButton.TextSize = 18
ToggleGUIButton.Parent = ScreenGui

local ToggleGUICorner = Instance.new("UICorner")
ToggleGUICorner.CornerRadius = UDim.new(0, 25)
ToggleGUICorner.Parent = ToggleGUIButton

local ToggleGUIStroke = Instance.new("UIStroke")
ToggleGUIStroke.Color = Color3.fromRGB(100, 100, 255)
ToggleGUIStroke.Thickness = 2
ToggleGUIStroke.Parent = ToggleGUIButton

-- Frame chính
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 280, 0, 200)
MainFrame.Position = UDim2.new(0.5, -140, 0.5, -100)
MainFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
MainFrame.BorderSizePixel = 0
MainFrame.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 10)
UICorner.Parent = MainFrame

-- Header
local Header = Instance.new("TextLabel")
Header.Name = "Header"
Header.Size = UDim2.new(1, 0, 0, 35)
Header.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
Header.BorderSizePixel = 0
Header.Font = Enum.Font.GothamBold
Header.Text = "Anti-Stun Controller"
Header.TextColor3 = Color3.fromRGB(255, 255, 255)
Header.TextSize = 16
Header.Parent = MainFrame

local HeaderCorner = Instance.new("UICorner")
HeaderCorner.CornerRadius = UDim.new(0, 10)
HeaderCorner.Parent = Header

-- Toggle Button
local ToggleButton = Instance.new("TextButton")
ToggleButton.Name = "ToggleButton"
ToggleButton.Size = UDim2.new(0, 240, 0, 35)
ToggleButton.Position = UDim2.new(0, 20, 0, 45)
ToggleButton.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
ToggleButton.BorderSizePixel = 0
ToggleButton.Font = Enum.Font.GothamBold
ToggleButton.Text = "Auto Anti-Stun: OFF"
ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleButton.TextSize = 14
ToggleButton.Parent = MainFrame

local ToggleCorner = Instance.new("UICorner")
ToggleCorner.CornerRadius = UDim.new(0, 8)
ToggleCorner.Parent = ToggleButton

-- Cooldown Display
local CooldownFrame = Instance.new("Frame")
CooldownFrame.Name = "CooldownFrame"
CooldownFrame.Size = UDim2.new(0, 240, 0, 35)
CooldownFrame.Position = UDim2.new(0, 20, 0, 90)
CooldownFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
CooldownFrame.BorderSizePixel = 0
CooldownFrame.Parent = MainFrame

local CooldownCorner = Instance.new("UICorner")
CooldownCorner.CornerRadius = UDim.new(0, 8)
CooldownCorner.Parent = CooldownFrame

local CooldownBar = Instance.new("Frame")
CooldownBar.Name = "CooldownBar"
CooldownBar.Size = UDim2.new(1, 0, 1, 0)
CooldownBar.BackgroundColor3 = Color3.fromRGB(100, 255, 100)
CooldownBar.BorderSizePixel = 0
CooldownBar.Parent = CooldownFrame

local CooldownBarCorner = Instance.new("UICorner")
CooldownBarCorner.CornerRadius = UDim.new(0, 8)
CooldownBarCorner.Parent = CooldownBar

local CooldownLabel = Instance.new("TextLabel")
CooldownLabel.Name = "CooldownLabel"
CooldownLabel.Size = UDim2.new(1, 0, 1, 0)
CooldownLabel.BackgroundTransparency = 1
CooldownLabel.Font = Enum.Font.GothamBold
CooldownLabel.Text = "Ready (Press B)"
CooldownLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
CooldownLabel.TextSize = 14
CooldownLabel.ZIndex = 2
CooldownLabel.Parent = CooldownFrame

-- Settings
local DurationInput = Instance.new("TextBox")
DurationInput.Name = "DurationInput"
DurationInput.Size = UDim2.new(0, 115, 0, 30)
DurationInput.Position = UDim2.new(0, 20, 0, 135)
DurationInput.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
DurationInput.BorderSizePixel = 0
DurationInput.Font = Enum.Font.Gotham
DurationInput.PlaceholderText = "Duration (s)"
DurationInput.Text = tostring(MANUAL_ANTI_STUN_DURATION)
DurationInput.TextColor3 = Color3.fromRGB(255, 255, 255)
DurationInput.TextSize = 12
DurationInput.Parent = MainFrame

local DurationCorner = Instance.new("UICorner")
DurationCorner.CornerRadius = UDim.new(0, 6)
DurationCorner.Parent = DurationInput

local CooldownInput = Instance.new("TextBox")
CooldownInput.Name = "CooldownInput"
CooldownInput.Size = UDim2.new(0, 115, 0, 30)
CooldownInput.Position = UDim2.new(0, 145, 0, 135)
CooldownInput.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
CooldownInput.BorderSizePixel = 0
CooldownInput.Font = Enum.Font.Gotham
CooldownInput.PlaceholderText = "Cooldown (s)"
CooldownInput.Text = tostring(COOLDOWN_TIME)
CooldownInput.TextColor3 = Color3.fromRGB(255, 255, 255)
CooldownInput.TextSize = 12
CooldownInput.Parent = MainFrame

local CooldownInputCorner = Instance.new("UICorner")
CooldownInputCorner.CornerRadius = UDim.new(0, 6)
CooldownInputCorner.Parent = CooldownInput

-- Hàm toggle GUI
local function ToggleGUI()
    guiVisible = not guiVisible
    MainFrame.Visible = guiVisible
    
    if guiVisible then
        ToggleGUIButton.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
        ToggleGUIStroke.Color = Color3.fromRGB(100, 100, 255)
    else
        ToggleGUIButton.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
        ToggleGUIStroke.Color = Color3.fromRGB(70, 70, 120)
    end
end

ToggleGUIButton.MouseButton1Click:Connect(ToggleGUI)

-- Draggable cho MainFrame
local dragging, dragInput, dragStart, startPos

local function update(input)
    local delta = input.Position - dragStart
    MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

Header.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

Header.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        update(input)
    end
end)

-- Draggable cho ToggleGUIButton
local draggingToggle, dragInputToggle, dragStartToggle, startPosToggle

local function updateToggle(input)
    local delta = input.Position - dragStartToggle
    ToggleGUIButton.Position = UDim2.new(startPosToggle.X.Scale, startPosToggle.X.Offset + delta.X, startPosToggle.Y.Scale, startPosToggle.Y.Offset + delta.Y)
end

ToggleGUIButton.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        draggingToggle = true
        dragStartToggle = input.Position
        startPosToggle = ToggleGUIButton.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                draggingToggle = false
            end
        end)
    end
end)

ToggleGUIButton.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInputToggle = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input == dragInputToggle and draggingToggle then
        updateToggle(input)
    end
end)

-- Toggle Auto Anti-Stun
ToggleButton.MouseButton1Click:Connect(function()
    ANTI_STUN_ENABLED = not ANTI_STUN_ENABLED
    
    if ANTI_STUN_ENABLED then
        ToggleButton.Text = "Auto Anti-Stun: ON"
        ToggleButton.BackgroundColor3 = Color3.fromRGB(50, 220, 50)
    else
        ToggleButton.Text = "Auto Anti-Stun: OFF"
        ToggleButton.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
    end
end)

-- Update settings
DurationInput.FocusLost:Connect(function()
    local value = tonumber(DurationInput.Text)
    if value and value > 0 and value <= 10 then
        MANUAL_ANTI_STUN_DURATION = value
    else
        DurationInput.Text = tostring(MANUAL_ANTI_STUN_DURATION)
    end
end)

CooldownInput.FocusLost:Connect(function()
    local value = tonumber(CooldownInput.Text)
    if value and value >= 0 and value <= 60 then
        COOLDOWN_TIME = value
    else
        CooldownInput.Text = tostring(COOLDOWN_TIME)
    end
end)

-- Hàm anti-stun
local function AntiStun()
    if not (ANTI_STUN_ENABLED or isManualAntiStunActive) then return end
    
    pcall(function()
        if HumanoidRootPart.Anchored then
            HumanoidRootPart.Anchored = false
        end
        
        if Humanoid.PlatformStand then
            Humanoid.PlatformStand = false
        end
        
        if Humanoid.Sit then
            Humanoid.Sit = false
        end
        
        for _, obj in pairs(HumanoidRootPart:GetChildren()) do
            if obj:IsA("BodyVelocity") or obj:IsA("BodyGyro") or 
               obj:IsA("BodyPosition") or obj:IsA("BodyThrust") then
                obj:Destroy()
            end
        end
    end)
end

-- Manual Anti-Stun (Press B) với visual feedback
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.KeyCode == KEYBIND and not isOnCooldown then
        isOnCooldown = true
        isManualAntiStunActive = true
        
        -- Active state
        CooldownLabel.Text = "ANTI-STUN ACTIVE!"
        CooldownBar.BackgroundColor3 = Color3.fromRGB(255, 255, 100)
        
        -- Anti-stun trong duration
        task.wait(MANUAL_ANTI_STUN_DURATION)
        isManualAntiStunActive = false
        
        -- Cooldown với thanh tiến trình
        local startTime = tick()
        local endTime = startTime + COOLDOWN_TIME
        
        CooldownBar.BackgroundColor3 = Color3.fromRGB(255, 100, 100)
        
        while tick() < endTime do
            local remaining = endTime - tick()
            local progress = remaining / COOLDOWN_TIME
            
            CooldownLabel.Text = string.format("Cooldown: %.1fs", remaining)
            CooldownBar.Size = UDim2.new(progress, 0, 1, 0)
            
            task.wait(0.05)
        end
        
        -- Ready state
        isOnCooldown = false
        CooldownLabel.Text = "Ready (Press B)"
        CooldownBar.BackgroundColor3 = Color3.fromRGB(100, 255, 100)
        CooldownBar.Size = UDim2.new(1, 0, 1, 0)
    end
end)

-- Toggle GUI bằng phím
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.KeyCode == TOGGLE_GUI_KEY then
        ToggleGUI()
    end
end)

-- Loop anti-stun
RunService.Heartbeat:Connect(AntiStun)

-- Reset khi respawn
LocalPlayer.CharacterAdded:Connect(function(newCharacter)
    Character = newCharacter
    Humanoid = Character:WaitForChild("Humanoid")
    HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
end)
