local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")

-- Cấu hình
local ANTI_STUN_ENABLED = false -- Tắt auto anti-stun
local MANUAL_ANTI_STUN_DURATION = 0.2 -- Thời gian anti-stun khi bấm 1
local COOLDOWN_TIME = 2 -- Thời gian hồi chiêu
local KEYBIND = Enum.KeyCode.One -- Phím kích hoạt (số 1)
local TOGGLE_GUI_KEY = Enum.KeyCode.LeftControl -- Phím bật/tắt GUI

local isOnCooldown = false
local isManualAntiStunActive = false
local isGUIVisible = true

-- Tạo GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AntiStunGUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

-- Frame chính
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 280, 0, 200)
MainFrame.Position = UDim2.new(0.5, -140, 0.5, -100)
MainFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
MainFrame.BorderSizePixel = 0
MainFrame.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 10)
UICorner.Parent = MainFrame

-- Header
local Header = Instance.new("TextLabel")
Header.Name = "Header"
Header.Size = UDim2.new(1, 0, 0, 35)
Header.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
Header.BorderSizePixel = 0
Header.Font = Enum.Font.GothamBold
Header.Text = "Anti-Stun Controller"
Header.TextColor3 = Color3.fromRGB(255, 255, 255)
Header.TextSize = 16
Header.Parent = MainFrame

local HeaderCorner = Instance.new("UICorner")
HeaderCorner.CornerRadius = UDim.new(0, 10)
HeaderCorner.Parent = Header

-- Toggle Button
local ToggleButton = Instance.new("TextButton")
ToggleButton.Name = "ToggleButton"
ToggleButton.Size = UDim2.new(0, 240, 0, 35)
ToggleButton.Position = UDim2.new(0, 20, 0, 45)
ToggleButton.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
ToggleButton.BorderSizePixel = 0
ToggleButton.Font = Enum.Font.GothamBold
ToggleButton.Text = "Auto Anti-Stun: OFF"
ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleButton.TextSize = 14
ToggleButton.Parent = MainFrame

local ToggleCorner = Instance.new("UICorner")
ToggleCorner.CornerRadius = UDim.new(0, 8)
ToggleCorner.Parent = ToggleButton

-- Cooldown Display
local CooldownFrame = Instance.new("Frame")
CooldownFrame.Name = "CooldownFrame"
CooldownFrame.Size = UDim2.new(0, 240, 0, 35)
CooldownFrame.Position = UDim2.new(0, 20, 0, 90)
CooldownFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
CooldownFrame.BorderSizePixel = 0
CooldownFrame.Parent = MainFrame

local CooldownCorner = Instance.new("UICorner")
CooldownCorner.CornerRadius = UDim.new(0, 8)
CooldownCorner.Parent = CooldownFrame

local CooldownLabel = Instance.new("TextLabel")
CooldownLabel.Name = "CooldownLabel"
CooldownLabel.Size = UDim2.new(1, 0, 1, 0)
CooldownLabel.BackgroundTransparency = 1
CooldownLabel.Font = Enum.Font.GothamBold
CooldownLabel.Text = "Ready (Press 1)"
CooldownLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
CooldownLabel.TextSize = 14
CooldownLabel.Parent = CooldownFrame

-- Settings
local DurationInput = Instance.new("TextBox")
DurationInput.Name = "DurationInput"
DurationInput.Size = UDim2.new(0, 115, 0, 30)
DurationInput.Position = UDim2.new(0, 20, 0, 135)
DurationInput.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
DurationInput.BorderSizePixel = 0
DurationInput.Font = Enum.Font.Gotham
DurationInput.PlaceholderText = "Duration (s)"
DurationInput.Text = tostring(MANUAL_ANTI_STUN_DURATION)
DurationInput.TextColor3 = Color3.fromRGB(255, 255, 255)
DurationInput.TextSize = 12
DurationInput.Parent = MainFrame

local DurationCorner = Instance.new("UICorner")
DurationCorner.CornerRadius = UDim.new(0, 6)
DurationCorner.Parent = DurationInput

local CooldownInput = Instance.new("TextBox")
CooldownInput.Name = "CooldownInput"
CooldownInput.Size = UDim2.new(0, 115, 0, 30)
CooldownInput.Position = UDim2.new(0, 145, 0, 135)
CooldownInput.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
CooldownInput.BorderSizePixel = 0
CooldownInput.Font = Enum.Font.Gotham
CooldownInput.PlaceholderText = "Cooldown (s)"
CooldownInput.Text = tostring(COOLDOWN_TIME)
CooldownInput.TextColor3 = Color3.fromRGB(255, 255, 255)
CooldownInput.TextSize = 12
CooldownInput.Parent = MainFrame

local CooldownInputCorner = Instance.new("UICorner")
CooldownInputCorner.CornerRadius = UDim.new(0, 6)
CooldownInputCorner.Parent = CooldownInput

-- Draggable
local dragging, dragInput, dragStart, startPos

local function update(input)
    local delta = input.Position - dragStart
    MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

Header.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

Header.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        update(input)
    end
end)

-- Toggle GUI Visibility (Left Ctrl)
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.KeyCode == TOGGLE_GUI_KEY then
        isGUIVisible = not isGUIVisible
        MainFrame.Visible = isGUIVisible
    end
end)

-- Toggle Auto Anti-Stun
ToggleButton.MouseButton1Click:Connect(function()
    ANTI_STUN_ENABLED = not ANTI_STUN_ENABLED
    
    if ANTI_STUN_ENABLED then
        ToggleButton.Text = "Auto Anti-Stun: ON"
        ToggleButton.BackgroundColor3 = Color3.fromRGB(50, 220, 50)
    else
        ToggleButton.Text = "Auto Anti-Stun: OFF"
        ToggleButton.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
    end
end)

-- Update settings
DurationInput.FocusLost:Connect(function()
    local value = tonumber(DurationInput.Text)
    if value and value > 0 and value <= 10 then
        MANUAL_ANTI_STUN_DURATION = value
    else
        DurationInput.Text = tostring(MANUAL_ANTI_STUN_DURATION)
    end
end)

CooldownInput.FocusLost:Connect(function()
    local value = tonumber(CooldownInput.Text)
    if value and value >= 0 and value <= 60 then
        COOLDOWN_TIME = value
    else
        CooldownInput.Text = tostring(COOLDOWN_TIME)
    end
end)

-- Hàm anti-stun
local function AntiStun()
    if not (ANTI_STUN_ENABLED or isManualAntiStunActive) then return end
    
    pcall(function()
        if HumanoidRootPart.Anchored then
            HumanoidRootPart.Anchored = false
        end
        
        if Humanoid.PlatformStand then
            Humanoid.PlatformStand = false
        end
        
        if Humanoid.Sit then
            Humanoid.Sit = false
        end
        
        for _, obj in pairs(HumanoidRootPart:GetChildren()) do
            if obj:IsA("BodyVelocity") or obj:IsA("BodyGyro") or 
               obj:IsA("BodyPosition") or obj:IsA("BodyThrust") then
                obj:Destroy()
            end
        end
    end)
end

-- Manual Anti-Stun (Press 1)
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.KeyCode == KEYBIND and not isOnCooldown then
        isOnCooldown = true
        isManualAntiStunActive = true
        
        CooldownLabel.Text = "ACTIVE!"
        CooldownLabel.TextColor3 = Color3.fromRGB(255, 255, 100)
        
        -- Anti-stun trong duration
        task.wait(MANUAL_ANTI_STUN_DURATION)
        isManualAntiStunActive = false
        
        -- Đếm ngược cooldown (chắc chắn hiện)
        for i = COOLDOWN_TIME * 10, 1, -1 do
            CooldownLabel.Text = string.format("Cooldown: %.1fs", i / 10)
            CooldownLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
            task.wait(0.1)
        end
        
        isOnCooldown = false
        CooldownLabel.Text = "Ready (Press 1)"
        CooldownLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
    end
end)

-- Loop anti-stun
RunService.Heartbeat:Connect(AntiStun)

-- Reset khi respawn
LocalPlayer.CharacterAdded:Connect(function(newCharacter)
    Character = newCharacter
    Humanoid = Character:WaitForChild("Humanoid")
    HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
end)
